{% extends 'base_template.html' %}
{% block main %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<div class="container-fluid">

    <!-- Page Heading -->
    <h1 class="h3 mb-2 text-gray-800">Inicio</h1>
    <p class="mb-4"></p>
    <!-- Content Row -->
    <div class="row">

        <div class="col-lg-6">

            <!-- Default Card Example -->
            <div class="card mb-4">
                <div class="card-header">
                    Clasificaci贸n
                </div>
                <div class="card-body">
                    <div class="preview" >
                        <img src="" id="img-classify" width="200" height="200">
                        <br>
                        Clasificaci贸n: <kbd id="classify"></kbd>
                        <br>
                        Exactitud: <kbd id="exactitud"></kbd>
                        <br>
                    </div>
                    <br>
                    <form id="upload-file" method="post" enctype="multipart/form-data">
                        <fieldset>
                            <label for="file">Select a file</label>
                            <input name="file" type="file">
                        </fieldset>
                        <fieldset>
                            <button id="upload-file-btn" type="button">Clasificar</button>
                        </fieldset>
                    </form>
                
                </div>
            </div>

            <div class="card mb-4">
                <div class="card-header">
                    Clasificaci贸n en tiempo real
                </div>
                <div class="card-body">
                    <div class="preview-irl" >
                        <button onclick="startWebcam();">Start WebCam</button>
                        <img id="my-data-uri" src="">
                        <br>
                        Clasificaci贸n: <kbd id="classify-irl"></kbd>
                        <br>
                        Exactitud: <kbd id="exactitud-irl"></kbd>
                        <br>
                    </div>
                    <br>
                    <form id="webcam" method="post" enctype="multipart/form-data">
                        <fieldset>
                            <button id="webcam" type="button">Clasificar</button>
                        </fieldset>
                    </form>
                
                </div>
            </div>

        </div>


    </div>

</div>
<style>
    .preview{
        display: none;
     }
</style>
<script>
    var canvas
var ctx
var video;
var webcamWidth;
var webcamHeight;

navigator.getUserMedia = (
  navigator.getUserMedia ||
  navigator.webkitGetUserMedia ||
  navigator.mozGetUserMedia ||
  navigator.msGetUserMedia
);

function startWebcam() {
  // canvas = document.getElementById("myCanvas")
  // video = document.getElementById('video')
  canvas = document.createElement('canvas')
  video = document.createElement('video')
  video.setAttribute('autoplay', true)
  ctx = canvas.getContext('2d')

  if (navigator.getUserMedia) {
    navigator.getUserMedia (
      {
        video: true,
        audio: false
      },

      function(stream) {
        webcamWidth = stream.getVideoTracks()[0].getSettings().width
        webcamHeight = stream.getVideoTracks()[0].getSettings().height
        canvas.setAttribute('width', webcamWidth);
        canvas.setAttribute('height', webcamHeight);

        // video.src = window.URL.createObjectURL(localMediaStream);
        video.srcObject = stream
      },

      function(err) {
        console.log( err);
      }
    );
  } else {
  console.log("getUserMedia not supported by your browser");
  }
}

function getCurrentFrame() {
  ctx.drawImage(video, 0,0)
  img_dataURI = canvas.toDataURL('image/png')
  document.getElementById("my-data-uri").src = img_dataURI
}
</script>
<script>
    $(function() {
        $('#upload-file-btn').click(function() {
            var form_data = new FormData($('#upload-file')[0]);
            $.ajax({
                type: 'POST',
                url: '/subir_imagen',
                data: form_data,
                contentType: false,
                cache: false,
                processData: false,
                success: function(data) {
                    console.log(data)
                    $("#img-classify").attr("src",'/display/'+data.filename);
                    $(".preview").show(); 
                    document.getElementById("classify").innerHTML = data.status_pieza;
                    document.getElementById("exactitud").innerHTML = data.accuracy;
                },
            });
        });
    });
</script>
{% endblock %}
